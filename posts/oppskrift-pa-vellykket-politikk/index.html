<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nikolai Hegertun">
<meta name="dcterms.date" content="2024-04-03">

<title>En oppskrift på vellykket politikk</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">En oppskrift på vellykket politikk</h1>
  <div class="quarto-categories">
    <div class="quarto-category">bokanmeldelse</div>
    <div class="quarto-category">politikk</div>
    <div class="quarto-category">bistand</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nikolai Hegertun </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 3, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Hvorfor lykkes politikk noen ganger, mens det andre ganger slår helt feil? Dette spørsmålet er utgangspunktet for Dennis C. Grubes bok <a href="https://www.panmacmillan.com/authors/dennis-c-grube/why-governments-get-it-wrong/9781529083330">«Why Governments Get It Wrong»</a>. Som tidligere politisk taleskriver og nå professor ved Cambridge og fungerende direktør ved Bennet Institute of Public Policy, bør Grube ha peiling på tematikken.</p>
<p><em>Nikolai Hegertun er statsviter og seniorrådgiver i seksjon for statistikk og analyse.</em></p>
<p>Politiske tiltak (eller «policy») spiller en helt avgjørende rolle i alle menneskers liv, og utgjør ifølge Grube den viktigste drivkraften for endring i verden. Problemet, mener Grube, er bare at myndigheter stadig knoter det til. Det kan være snakk om tiltak mot overvekt eller hjemløshet, kriminalomsorg, smittevernstiltak, intervensjoner i Afghanistan, eller skattekutt for de aller rikeste som Storbritannias tidligere statsminister Liz Truss så vidt rakk å foreslå før hun måtte gå – alle er de eksempler på politikk som har mislyktes. Noen policyer er dødfødte fra dag én, mens andre er designet på en måte som gjør at fiaskoen oppdages først etter en stund, eller fordi rammebetingelsene har blitt endret.</p>
<p>Det finnes imidlertid én oppskrift på hvordan man kan lykkes med policy, ifølge Grube. Den er ikke alltid like enkel å utføre, men har grunnleggende sett kun fire steg:</p>
<ol type="1">
<li>En god problemdefinisjon</li>
<li>En god historie (som baserer seg på problemet) folk flest kan følge</li>
<li>Data og evidens (fakta) som underbygger problemdefinisjonen</li>
<li>En effektiv intervensjon/praktisk løsning</li>
</ol>
<p>Vellykket policy er ikke bare viktig for å gjøre verden til et bedre sted, ifølge Grube, det er også viktig fordi det som regel konverteres til vellykket <em>politikk</em>: at velgere lar seg overbevise om at politikerne har gjort seg fortjent til å fortsette å styre.</p>
<section id="et-godt-problem" class="level2">
<h2 class="anchored" data-anchor-id="et-godt-problem">Et godt problem</h2>
<p>La oss se litt nærmere på hvert steg i oppskriften. En <strong>problemdefinisjon</strong> er ifølge Grube en miks av ideologi, verdenssyn og et utilfredsstillende tilfang av evidens. Det er altså en subjektiv vurdering som ofte fremstilles som en objektiv analyse. Som Gruber skriver:</p>
<blockquote class="blockquote">
<p>All problems come in pieces, and politicians try to put them together for us in ways that will make us buy into their worldview.</p>
</blockquote>
<p>Problemdefinisjonen er det springende punkt for å lykkes med politikkutforming ettersom den rammer inn resten av oppskriften: får man oppslutning om sin beskrivelse av et problem får man også muligheten til å utvikle policy. Mange problemer kan ligge og ulme under overflaten, nærmest som en «tilstand», og vil trenge en utløsende hendelse for å komme på dagsordenen. Det betyr imidlertid ikke at problemdefinisjonen er klar, selv om man kanskje skulle tro det. Det kan være uløste konflikter som blusser opp igjen eller etterslep på vedlikehold av viktig infrastruktur som resulterer i ulykker. Men blir man ikke enige i problembeskrivelsen vil man heller ikke komme videre til en faktisk løsning via policy.</p>
</section>
<section id="en-god-historie" class="level2">
<h2 class="anchored" data-anchor-id="en-god-historie">En god historie</h2>
<p>Hvordan vi senere omtaler problemet inngår i punkt to: <strong>historiefortellingen</strong>. Historiefortellingen er den følelsesmessige forankringen som gir mening og en helhet til både problemet og hvordan løsningen kan se ut. Tidligere president Donald Trumps dystre historiefortelling om amerikansk forfall kan tjene som et eksempel.</p>
</section>
<section id="et-solid-faktagrunnlag" class="level2">
<h2 class="anchored" data-anchor-id="et-solid-faktagrunnlag">Et solid faktagrunnlag</h2>
<p>Men ingen historie eller problemforståelse står seg uten <strong>data</strong> og <strong>evidens</strong>. Og motsatt: selv om et fagdirektorat som Norad liker å smykke oss med slagordet «fakta har makta», så taler data og evidens svært sjeldent for seg selv. Under pandemien var datatilfanget overveldende: det var daglige oppdateringer om antall smittede, symptomer, antall innlagte, døde etc. Likevel, som Grube illustrerer: land som Norge, Sverige, Brasil og New Zealand valgte svært ulike måter å respondere på dette faktagrunnlaget. En annen utfordring knyttet til sammenhengen mellom problemdefinisjon, historiefortelling og fakta som Grube viser til er den tidligere amerikanske utenriksministeren Colin Powells store fortelling om masseødeleggelsesvåpen som påskudd for å invadere Irak (som nettopp manglet evidens). Eller på et mikronivå: når populistiske politikere som har avfeid faren ved covid-19 selv blir svært syke og må ha behandling. Et godt evidensgrunnlag er limet i det politiske narrativet, og uten dette vil ethvert politisk initiativ omsider klappe sammen.</p>
</section>
<section id="effektive-tiltak" class="level2">
<h2 class="anchored" data-anchor-id="effektive-tiltak">Effektive tiltak</h2>
<p>Det siste punktet handler om å designe en <strong>intervensjon</strong> som følger naturlig i tråd med problembeskrivelsen, historien og fakta. Intervensjonen er sannhetens øyeblikk for enhver beslutningstaker: Hvis problemet er upresist definert og faktaene ikke henger på greip vil intervensjonen raskt vise seg mislykket, påpeker Grube. På dette stadiet kan selvsagt en rekke problemer melde seg: implementeringen kan svikte, «handlekraftige» politikere kan hoppe på løsninger for tidlig, man kan velge løsninger som for øyeblikket er populære, men som på sikt bare gjør vondt verre (f.eks. upopulære miljøtiltak) eller man kan ende med å håndtere symptomer og ikke de underliggende problemene.</p>
<p>Grubers bok minner oss om flere svært vellykkede policyer, hvorav noen spredte seg verden over. «Røykeloven» som vi kaller den i Norge er ett slikt eksempel. Til tross for tidlig og kortlevd motstand i mange land har slike tiltak hatt 1) en god problembeskrivelse (helseskader for millioner av røykere og passive røykere) 2) en god historie (røykerne og deres familier er <em>ofrene</em>, ikke skurkene), 3) fakta og evidens (dokumentasjon om skadevirkninger har eksistert i flere tiår) og 4) intervensjoner som virker (ikke bøter og straff, men røykfrie områder og avgifter på tobakksvarer).</p>
</section>
<section id="hva-så-for-bistanden" class="level2">
<h2 class="anchored" data-anchor-id="hva-så-for-bistanden">Hva så for bistanden?</h2>
<p>Det er flere aspekt i Grubers bok som bør vekke interesse og muligens noen bekymringer for alle som er interessert i bistand og internasjonalt utviklingssamarbeid. Ettersom bistand er et politikkfelt som svever litt mellom hjemlig politikk, internasjonale relasjoner og andre lands politikk blir dette puslespillet ofte enda mer komplisert.</p>
<p>En god policy er for eksempel ikke nødvendigvis en god policy for evig og alltid. Den må alltid oppdateres i tråd med konteksten og endringer i evidens. Dette kan være vanskelig for eksterne aktører som ikke sitter med hovedansvaret eller sektoransvaret i et land. Bistanden har nok en hang til å ty til policyer som har lykkes noen steder, men uten at man sikkert kan si at betingelsene for suksess er til stede andre steder (mangelen på denne lokalkunnskapen er nettopp noe av grunnen til at man tyr til internasjonale suksesser, såkalt «best practices»).</p>
<p>Arbeidet med problemdefinisjon og historiefortelling blir også mer komplisert. Selv om det muligens er enkelt for politikere å få vedtatt bistandsprioriteringer på hjemmebane vil en betydningsfull endring «på bakken» innebære at en rekke internasjonale aktører, samt interessegrupper og eliter i andre land, må overbevises. Eller endog at det som utgjør et vellykket policy-narrativ i giverlandet langt fra vil være det som trengs i et partnerland. Evidens og data om både problem og årsaksforhold vil ofte være vanskeligere å oppnå i bistanden. Om selve intervensjonen-fasen sier Gruber eksplisitt at dette steget er «really hard». Og mange av de utfordringene han beskriver vil også forsterkes innenfor bistanden all den tid det er snakk om komplekse og dynamiske årsakskjeder som gir ulike reaksjoner og uintenderte konsekvenser som man vil slite med å ha oversikt over.</p>
<section id="flere-fluer-i-en-bistands-smekk" class="level3">
<h3 class="anchored" data-anchor-id="flere-fluer-i-en-bistands-smekk">Flere fluer i en bistands-smekk…</h3>
<p>Bistandens utgangspunkt, med begrensede midler, store ambisjoner og et mangslungent aktørfelt vil i mange tilfeller bety at problemdefinisjoner vil bli omdiskutert og bestridt. Dette utgangspunktet og problemenes faktiske kompleksitet – i tillegg til de normative og giver-initierte føringene for bistanden – vil nok påvirke målene man setter for intervensjonen. Med andre ord, vil det være fristende å forsøke å slå flere fluer i en smekk med noen få tiltak fremfor at intervensjonen «matcher» problemets kompleksitet (enten dette er styresett, ulikhet, likestilling eller økonomisk utvikling). Grube minner om at flere av problemene rike land har på hjemmebane, enten dette er overvekt, alkoholmisbruk eller kriminalitet, sliter vi med å løse fordi de er sammensatt av mange faktorer (oppvekstsvilkår, skole, familierelasjoner, kulturelle normer, genetiske predisposisjoner).</p>
</section>
<section id="eller-fokuserte-innsatser" class="level3">
<h3 class="anchored" data-anchor-id="eller-fokuserte-innsatser">…eller fokuserte innsatser?</h3>
<p>Det er likevel verdt å nevne at man gjennom internasjonalt samarbeid faktisk <em>har</em> klart å løse en rekke problemer gjennom nettopp klare og konsensusbaserte problemdefinisjoner, god evidens og fokuserte intervensjoner (f.eks. bekjempelse av malaria, HIV/AIDS og barnedødelighet). Også et mer komplisert grensesprengende problem som nedbrytningen av ozonlaget evnet verden å reversere gjennom en klar problemforståelse «alle» forsto (alvorlig sykdom hos mennesker og dyr), et godt faktagrunnlag (dokumentasjon om årsaksforhold og virkninger) og en svært effektiv intervensjon (alternativ teknologi ble gjort tilgjengelig og handelsrestriksjoner innført for de land som ikke skiftet praksis).</p>
</section>
</section>
<section id="treg-og-gradvis-endring" class="level2">
<h2 class="anchored" data-anchor-id="treg-og-gradvis-endring">Treg og gradvis endring</h2>
<p>Et siste aspekt som Grube ikke går inn på i sin bok er hvordan selve demokratiet ofte fungerer som en treg og gradvis (inkrementell) policy-endrer. Noen av de viktigste bidragsyterne til litteraturen om politikkutforming, for eksempel <span class="citation" data-cites="dahl1992politics">Dahl (<a href="#ref-dahl1992politics" role="doc-biblioref">1992</a>)</span> og <span class="citation" data-cites="lindblom1959science">Lindblom (<a href="#ref-lindblom1959science" role="doc-biblioref">1959</a>)</span>, har omtalt beslutningstakere som Ole Brum-aktige figurer («a bear of very little brain»), som nettopp på grunn av sine menneskelige begrensinger hva gjelder oppmerksomhet, kunnskap og analyse vil være varsomme med å ta <em>for</em> store politiske beslutninger eller foreta radikale endringer. Dagens politikere står tross alt i en lengre historisk linje, der kumulativt oppsamlet innsikt, erfaringer, kompromisser og forhandlinger, har ledet politikken i en viss retning. Ifølge en annen viktig teoretiker, Paul Pierson, gjør dette at tidligere vedtatt politikk har en tendens til å sette et mønster eller en retning som avleirer seg i stabilitet – som videre vanskeliggjør revers eller et tydelig brudd med eksisterende politikk <span class="citation" data-cites="pierson2004politics">(<a href="#ref-pierson2004politics" role="doc-biblioref">Pierson 2004</a>)</span>. Dette er en særskilt utfordring for de som ønsker å endre bistanden, ettersom eksisterende policy i tillegg er omhyllet av et normativt slør. I tilfeller der man må velge mellom nødlidende grupper er det derfor ekstra viktig at faktagrunnlaget er solid.</p>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-dahl1992politics" class="csl-entry" role="listitem">
Dahl, Robert A. 1992. <em>Politics, Economics, and Welfare</em>. New York: Routledge.
</div>
<div id="ref-grube2023governments" class="csl-entry" role="listitem">
Grube, Dennis C. 2023. <em>Why Governments Get It Wrong: And How They Can Get It Right</em>. London: Pan Macmillan.
</div>
<div id="ref-lindblom1959science" class="csl-entry" role="listitem">
Lindblom, Charles E. 1959. <span>“The Science of "Muddling Through".”</span> <em>Public Administration Review</em> 19 (2): 79–88.
</div>
<div id="ref-pierson2004politics" class="csl-entry" role="listitem">
Pierson, Paul. 2004. <em>Politics in Time: History, Institutions, and Social Analysis</em>. Princeton, NJ: Princeton University Press.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>